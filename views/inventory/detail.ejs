
<h1><%- title %></h1>
<%- messages() %>
<% if (errors) { %>
    <ul class="notice">
   <% errors.array().forEach(error => { %>
     <li><%= error.msg %></li>
  <%  }) %>
   </ul>
  <% } %>

<section id="reviews" class="container mt-5">
  <h2>Reviews</h2>

  <% if (messages && messages.error) { %>
    <div class="alert alert-danger"><%= messages.error %></div>
  <% } %>
  <% if (messages && messages.success) { %>
    <div class="alert alert-success"><%= messages.success %></div>
  <% } %>

  <% if (!reviews || reviews.length === 0) { %>
    <p>No reviews yet.</p>
  <% } else { %>
    <% reviews.forEach(function(r) { 
         const firstInitial = r.first_name ? r.first_name.charAt(0) : '';
         const lastNoSpaces = r.last_name ? r.last_name.replace(/\s+/g, '') : '';
         const screenName = firstInitial + lastNoSpaces;
    %>
      <article class="review card mb-3 p-3">
        <div class="review-meta small text-muted">
          <strong><%= screenName %></strong> â€” <%= new Date(r.review_date).toLocaleString() %>
        </div>
        <div class="review-text mt-2"><%= r.review_text %></div>
      </article>
    <% }) %>
  <% } %>

  <% if (!account) { %>
    <p class="mt-3">You can add a review by <a href="/account/login">logging in</a>.</p>
  <% } else { %>
    <form id="addReviewForm" action="/reviews/add" method="POST" class="mt-3">
      <div class="mb-2">
        <label for="screen_name" class="form-label">Screen name</label>
        <input type="text" id="screen_name" class="form-control" value="<%= (account.first_name ? account.first_name.charAt(0) : '') + (account.last_name ? account.last_name.replace(/\s+/g,'') : '') %>" readonly>
      </div>
      <div class="mb-2">
        <label for="review_text" class="form-label">Your review</label>
        <textarea id="review_text" name="review_text" rows="4" class="form-control" required><%= pendingReview ? pendingReview.review_text : '' %></textarea>
        <% if (messages && messages.error) { %>
        <% } %>
      </div>
      <input type="hidden" name="inv_id" value="<%= item.inv_id %>">
      <input type="hidden" name="account_id" value="<%= account.account_id %>">
      <button type="submit" class="btn btn-primary">Submit Review</button>
    </form>
  <% } %>
</section>
