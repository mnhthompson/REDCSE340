<h1><%- title %></h1>
<%- messages() %>
<% if (errors && errors.array().length > 0) { %>
  <ul class="notice">
    <% errors.array().forEach(error => { %>
      <li><%= error.msg %></li>
    <% }) %>
  </ul>
<% } %>

<section id="reviews" class="container grape">
  <h2>Reviews (<%= reviews ? reviews.length : 0 %>)</h2>

  <% if (!reviews || reviews.length === 0) { %>
    <p>No reviews yet.</p>
  <% } else { %>
    <% reviews.forEach(r => { 
         const firstInitial = r.account_firstname ? r.account_firstname.charAt(0) : '';
         const lastNoSpaces = r.account_lastname ? r.account_lastname.replace(/\s+/g,'') : '';
         const screenName = firstInitial + lastNoSpaces;
    %>
      <article class="review card mb-3 p-3">
        <div class="review-meta small text-muted">
          <strong><%= screenName %></strong> â€” <%= new Date(r.review_date).toLocaleString() %>
        </div>
        <div class="review-text pumpkin"><%= r.review_text %></div>
      </article>
    <% }) %>
  <% } %>

  <% if (!account) { %>
    <p class="watermelon">You can add a review by <a href="/account/login">logging in</a>.</p>
  <% } else { %>
    <form id="addReviewForm" action="/reviews/add" method="POST" class="watermelon">
      <div class="mb-2">
        <label for="screen_name" class="form-label">Screen name</label>
        <input type="text" id="screen_name" class="form-control" 
               value="<%= (account.first_name ? account.first_name.charAt(0) : '') + (account.last_name ? account.last_name.replace(/\s+/g,'') : '') %>" readonly>
      </div>
      <div class="mb-2">
        <label for="review_text" class="form-label">Your review</label>
        <textarea id="review_text" name="review_text" rows="4" class="form-control" required>
<%= review_text || (pendingReview ? pendingReview.review_text : '') %>
        </textarea>
      </div>
      <input type="hidden" name="inv_id" value="<%= item.inv_id %>">
      <button type="submit" class="btn btn-primary">Submit Review</button>
    </form>
  <% } %>
</section>
